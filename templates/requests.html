{# templates/my_requests.html #}
{% extends "base.html" %}
{% block title %}My Requests{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">My Requests</h2>

  {# Collect whichever iterable the view supplied, without breaking if a name is missing #}
  {% set _all_requests =
      (requests | default([]))
      + (leave_requests | default([]))
      + (my_requests | default([]))
      + (leaves | default([]))
      + (user_requests | default([]))
      + (records | default([]))
  %}

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Kind</th>
          <th>Mode</th>
          <th>Dates</th>
          <th>Hours</th>
          <th>Status</th>
          <th>School?</th>
          <th>Substitutes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for req in _all_requests %}
        <tr>
          <td>{{ req.id }}</td>

          <td>
            {# Prefer nested username if present, otherwise show whatever user value exists #}
            {% if req.user and req.user.username is defined %}
              {{ req.user.username }}
            {% else %}
              {{ req.user if req.user is defined else "" }}
            {% endif %}
          </td>

          <td>{{ req.kind }}</td>
          <td>{{ req.mode }}</td>

          {# === ONLY ADDITION: show (Start – End) when both times exist === #}
          <td>
            {{ req.start_date }} → {{ req.end_date }}
            {% if req.start_time and req.end_time %}
              ({{ req.start_time.strftime("%I:%M %p").lstrip('0') }} – {{ req.end_time.strftime("%I:%M %p").lstrip('0') }})
            {% endif %}
          </td>
          {# ================================================ #}

          <td>
            {# Keep whatever you store in hours; if it's numeric it will render as usual #}
            {{ req.hours }}
          </td>

          <td>{{ req.status }}</td>

          <td>
            {# Show the stored value directly to avoid changing behavior #}
            {{ req.school }}
          </td>

          <td>
            {% if req.substitutes is defined and req.substitutes %}
              <ul class="mb-0">
                {% for sub in req.substitutes %}
                  <li>
                    {{ sub.name if sub.name is defined else sub }}
                    {% if sub.hours is defined and sub.hours %} — {{ sub.hours }}h{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              &ndash;
            {% endif %}
          </td>

          <td>
            {# Keep your existing actions if you had them; placeholders are harmless #}
            <div class="d-flex gap-2">
              {% if req.can_add_sub %}<a class="btn btn-sm btn-outline-primary" href="{{ url_for('add_substitute', request_id=req.id) }}">Add Sub</a>{% endif %}
              {% if req.can_cancel %}<a class="btn btn-sm btn-outline-danger" href="{{ url_for('cancel_request', request_id=req.id) }}">Cancel</a>{% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="10" class="text-center text-muted">No requests to display.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# If you already had pagination in your view context, this keeps working exactly the same #}
  {% if pagination %}
    <nav aria-label="My Requests pagination" class="mt-3">
      <ul class="pagination">
        {% if pagination.prev_num %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('my_requests', page=pagination.prev_num) }}">Previous</a>
          </li>
        {% endif %}
        <li class="page-item disabled">
          <span class="page-link">Page {{ pagination.page }} of {{ pagination.pages }}</span>
        </li>
        {% if pagination.next_num %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('my_requests', page=pagination.next_num) }}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
