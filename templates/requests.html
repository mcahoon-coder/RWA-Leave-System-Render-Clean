{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>{{ title }}</h2>

  {% if is_admin and staff_overview %}
  <h4>Employees</h4>
  <table class="table table-bordered table-sm">
    <thead class="table-light">
      <tr>
        <th>Username</th>
        <th>Hours Balance</th>
        <th>Pending?</th>
      </tr>
    </thead>
    <tbody>
      {% for u in staff_overview %}
      <tr>
        <td>{{ u.username }}</td>
        <td>{{ "%.2f"|format(u.hours_balance) }}</td>
        <td>
          {% if u.has_pending %}
          <span class="badge bg-warning text-dark">Pending</span>
          {% else %}
          <span class="badge bg-success">Clear</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  <h4 class="mt-4">Requests</h4>
  <table class="table table-striped table-bordered align-middle">
    <thead class="table-light">
      <tr>
        {% if is_admin %}
        <th>User</th>
        {% endif %}
        <th>Kind</th>
        <th>Mode</th>
        <th>Hours</th>
        <th>Dates</th>
        <th>Time Window</th> <!-- NEW -->
        <th>Status</th>
        <th>Reason</th>
        <th>Substitutes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in reqs %}
      <tr>
        {% if is_admin %}
        <td>{{ r.user.staff_name or r.user.username }}</td>
        {% endif %}
        <td>{{ r.kind }}</td>
        <td>{{ r.mode }}</td>
        <td>{{ "%.2f"|format(r.hours) }}</td>
        <td>{{ r.start_date }} → {{ r.end_date }}</td>
        <td>
          {% if r.mode == "hourly" and r.start_time and r.end_time %}
            {{ r.start_time|h12 }} – {{ r.end_time|h12 }} ({{ "%.2f"|format(r.hours) }}h)
          {% endif %}
        </td>
        <td>{{ r.status }}</td>
        <td>{{ r.reason }}</td>
        <td>
          {% if r.subs %}
            {% for s in r.subs %}
              {{ s.name }} ({{ "%.2f"|format(s.hours) }}h){% if not loop.last %}, {% endif %}
            {% endfor %}
          {% elif r.substitute %}
            {{ r.substitute }}
          {% endif %}
        </td>
        <td>
          {% if is_admin %}
            {% if r.status == "Pending" %}
              <form method="post" action="{{ url_for('approve', req_id=r.id) }}" style="display:inline">
                <button type="submit" class="btn btn-success btn-sm">Approve</button>
              </form>
              <form method="post" action="{{ url_for('disapprove', req_id=r.id) }}" style="display:inline">
                <button type="submit" class="btn btn-danger btn-sm">Disapprove</button>
              </form>
            {% endif %}
          {% endif %}
          {% if r.user_id == me.id or is_admin %}
            {% if r.status in ["Pending","Approved"] %}
              <form method="post" action="{{ url_for('cancel', req_id=r.id) }}" style="display:inline">
                <button type="submit" class="btn btn-secondary btn-sm">Cancel</button>
              </form>
            {% endif %}
          {% endif %}
          {% if is_admin %}
            <!-- Manage substitutes -->
            <form method="post" action="{{ url_for('add_substitute', req_id=r.id) }}" class="d-flex mt-2">
              <input type="text" name="sub_name" placeholder="Substitute" class="form-control form-control-sm me-2" required>
              <input type="number" name="sub_hours" step="0.25" min="0" placeholder="Hours" class="form-control form-control-sm me-2" style="max-width:100px">
              <button type="submit" class="btn btn-outline-primary btn-sm">Add</button>
            </form>
            {% for s in r.subs %}
            <form method="post" action="{{ url_for('update_substitute', req_id=r.id, sub_id=s.id) }}" class="d-flex mt-1">
              <input type="text" name="sub_name" value="{{ s.name }}" class="form-control form-control-sm me-2">
              <input type="number" name="sub_hours" step="0.25" value="{{ "%.2f"|format(s.hours) }}" class="form-control form-control-sm me-2" style="max-width:100px">
              <button type="submit" class="btn btn-outline-success btn-sm me-1">Update</button>
            </form>
            <form method="post" action="{{ url_for('delete_substitute', req_id=r.id, sub_id=s.id) }}" style="display:inline">
              <button type="submit" class="btn btn-outline-danger btn-sm mt-1">Delete</button>
            </form>
            {% endfor %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
