{% extends "base.html" %}
{% block title %}{{ 'Requests' if is_admin else 'My Requests' }}{% endblock %}

{% block content %}
  <div class="card">
    <h1 style="margin-top:0;">{{ 'Requests' if is_admin else 'My Requests' }}</h1>

    <!-- Filters only -->
    <form method="get" action="{{ NAV.my_requests }}">
      <div class="form-grid-2">
        <div>
          <label>Status</label>
          <select name="status">
            {% set s = (status or 'all')|lower %}
            {% for x in ['all','Pending','Approved','Disapproved','Cancelled'] %}
              <option value="{{ x }}" {% if x|lower == s %}selected{% endif %}>{{ x }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Start (optional)</label>
          <input type="date" name="start" value="{{ start or '' }}">
        </div>
        <div>
          <label>End (optional)</label>
          <input type="date" name="end" value="{{ end or '' }}">
        </div>
        <div class="full">
          <button class="btn" type="submit">Apply</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Results</h2>

    {% set items = reqs or requests %}
    {% if items and items|length %}
      <table>
        <thead>
          <tr>
            <th>ID</th>
            {% if is_admin %}<th>User</th>{% endif %}
            <th>Kind</th>
            <th>Mode</th>
            <th>Hours</th>
            <th>Status</th>
            <th>Start</th>
            <th>End</th>
            <th>Reason</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in items %}
          <tr>
            <td>{{ r.id }}</td>
            {% if is_admin %}<td>{{ r.user.username }}</td>{% endif %}
            <td>{{ r.kind }}</td>
            <td>{{ r.mode }}</td>
            <td>{{ '%.2f'|format(r.hours) }}</td>
            <td>{{ r.status }}</td>
            <td>{{ r.start_date }}</td>
            <td>{{ r.end_date }}</td>
            <td>{{ r.reason }}</td>
            <td>
              {% if is_admin %}
                {% if r.status == 'Pending' %}
                  <form method="post" action="{{ url_for('approve', req_id=r.id) }}" style="display:inline;">
                    <button class="btn" type="submit">Approve</button>
                  </form>
                  <form method="post" action="{{ url_for('disapprove', req_id=r.id) }}" style="display:inline;">
                    <button class="btn" type="submit">Disapprove</button>
                  </form>
                {% endif %}
                {% if r.status != 'Cancelled' %}
                  <form method="post" action="{{ url_for('cancel', req_id=r.id) }}" style="display:inline;">
                    <button class="btn" type="submit">Cancel</button>
                  </form>
                {% endif %}
              {% else %}
                {% if r.user_id == me.id and r.status != 'Cancelled' %}
                  <form method="post" action="{{ url_for('cancel', req_id=r.id) }}" style="display:inline;">
                    <button class="btn" type="submit">Cancel</button>
                  </form>
                {% else %}
                  â€”
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No requests match your filters.</p>
    {% endif %}
  </div>
{% endblock %}
