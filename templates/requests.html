{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>My Requests</h2>

    <!-- Staff overview for admins -->
    {% if is_admin and staff_overview %}
        <h3 class="mt-3">Employees at a Glance</h3>
        <div class="row">
            {% for u in staff_overview %}
            <div class="col-md-3 mb-3">
                <div class="card {% if u.has_pending %}border-warning{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title">{{ u.username }}</h5>
                        <p class="card-text">
                            Balance:
                            <span class="{% if u.hours_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "%.2f"|format(u.hours_balance) }}h
                            </span>
                        </p>
                        {% if u.has_pending %}
                            <span class="badge bg-warning text-dark">Pending</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Filters -->
    <form method="get" class="row g-3 mb-3">
        <div class="col-auto">
            <label for="status" class="form-label">Status</label>
            <select name="status" id="status" class="form-select">
                <option value="all" {% if status=='all' %}selected{% endif %}>All</option>
                <option value="pending" {% if status=='pending' %}selected{% endif %}>Pending</option>
                <option value="approved" {% if status=='approved' %}selected{% endif %}>Approved</option>
                <option value="disapproved" {% if status=='disapproved' %}selected{% endif %}>Disapproved</option>
                <option value="cancelled" {% if status=='cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        <div class="col-auto">
            <label for="start" class="form-label">Start Date</label>
            <input type="date" class="form-control" name="start" id="start" value="{{ start }}">
        </div>
        <div class="col-auto">
            <label for="end" class="form-label">End Date</label>
            <input type="date" class="form-control" name="end" id="end" value="{{ end }}">
        </div>
        <div class="col-auto align-self-end">
            <button type="submit" class="btn btn-primary">Filter</button>
        </div>
    </form>

    <!-- Grouped Requests -->
    {% set current_date = None %}
    {% for r in reqs %}
        {% set day = r.created_at.date() if r.created_at else None %}
        {% if day != current_date %}
            {% if not loop.first %}
                </tbody></table>
            {% endif %}
            <h4 class="mt-4">{{ day }}</h4>
            <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Kind</th>
                        <th>Mode</th>
                        <th class="date-col">Dates</th>
                        <th>Times</th>
                        <th>Hours</th>
                        <th>Status</th>
                        <th>School?</th>
                        <th>Substitutes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            {% set current_date = day %}
        {% endif %}

        <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.user.username }}</td>
            <td>{{ r.kind }}</td>
            <td>{{ r.mode }}</td>
            <td class="date-col">{{ r.start_date }} → {{ r.end_date }}</td>
            <td>
                {% if r.start_time %}{{ r.start_time|h12 }}{% else %}-{% endif %}
                →
                {% if r.end_time %}{{ r.end_time|h12 }}{% else %}-{% endif %}
            </td>
            <td>{{ "%.2f"|format(r.hours) }}</td>
            <td>{{ r.status }}</td>
            <td>{{ "Yes" if r.is_school_related else "No" }}</td>
            <td>
                {% if r.subs %}
                    {% for s in r.subs %}
                        {{ s.name }} ({{ "%.2f"|format(s.hours) }}h){% if not loop.last %}, {% endif %}
                    {% endfor %}
                {% elif r.substitute %}
                    {{ r.substitute }}
                {% else %}
                    –
                {% endif %}
            </td>
            <td>
                <!-- Employee Cancel Button -->
                {% if r.status == "Pending" and r.user_id == me.id %}
                    <form action="{{ url_for('cancel', req_id=r.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-warning">Cancel</button>
                    </form>
                {% endif %}

                <!-- Admin Actions -->
                {% if is_admin %}
                    <a href="{{ url_for('edit_request', req_id=r.id) }}" class="btn btn-sm btn-primary">Edit</a>
                    <form action="{{ url_for('cancel', req_id=r.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Cancel</button>
                    </form>
                {% endif %}
            </td>
        </tr>
    {% else %}
        <tr><td colspan="11" class="text-center">No requests to display.</td></tr>
    {% endfor %}
    </tbody></table>
</div>
</div>
{% endblock %}
