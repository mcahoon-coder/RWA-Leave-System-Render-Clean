{% extends "base.html" %}
{% block content %}
<div class="content-wrapper">
  <h2>Welcome, {{ me.username }}</h2>

  <!-- Quick stats -->
  <div class="cards-grid">
    <div class="card kpi">
      <div class="card-body">
        <div class="kpi-title">Hours Balance</div>
        <div class="kpi-value {% if (me.hours_balance or 0) < 0 %}neg{% endif %}">
          {{ '%.2f'|format(me.hours_balance or 0.0) }} h
        </div>
        <div class="kpi-sub">Standard workday: {{ '%.2f'|format(workday or 8) }} h</div>
      </div>
    </div>

    <div class="card kpi">
      <div class="card-body">
        <div class="kpi-title">Pending Requests</div>
        <div class="kpi-value">
          {{ recent | selectattr('status','equalto','Pending') | list | length }}
        </div>
        <div class="kpi-sub">Last 10 submissions</div>
      </div>
    </div>

    <div class="card kpi">
      <div class="card-body">
        <div class="kpi-title">Approved (Recent)</div>
        <div class="kpi-value">
          {{ recent | selectattr('status','equalto','Approved') | list | length }}
        </div>
        <div class="kpi-sub">Last 10 submissions</div>
      </div>
    </div>
  </div>

  <!-- Quick actions -->
  <div class="card">
    <div class="card-body">
      <div class="form-actions" style="justify-content:flex-start;">
        <a class="btn" href="{{ url_for('new_request') }}">Request Leave</a>
        <a class="btn btn-secondary" href="{{ url_for('my_requests') }}">View My Requests</a>
        <a class="btn btn-ghost" href="{{ url_for('calendar') }}">Calendar</a>
        <a class="btn btn-ghost" href="{{ url_for('update_password') }}">Change Password</a>
        {% if current_user.role == 'admin' %}
          <a class="btn btn-ghost" href="{{ url_for('manage_users') }}">Manage Users</a>
          <a class="btn btn-secondary" href="{{ url_for('export_requests_csv') }}">Export CSV</a>
          <a class="btn btn-secondary" href="{{ url_for('export_requests_xlsx') }}">Export Excel</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Recent requests -->
  <div class="card">
    <div class="card-body">
      <h3 style="margin-top:0;">Your Recent Requests</h3>
      {% if recent %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Kind</th>
              <th>Mode</th>
              <th>Hours</th>
              <th>Start</th>
              <th>End</th>
              <th>Status</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody>
          {% for r in recent %}
            <tr>
              <td class="nowrap">{{ r.kind|capitalize }}</td>
              <td class="nowrap">{{ r.mode|capitalize }}</td>
              <td class="nowrap">{{ '%.2f'|format(r.hours or 0.0) }}</td>
              <td class="nowrap">{{ r.start_date.strftime('%Y-%m-%d') }}</td>
              <td class="nowrap">{{ r.end_date.strftime('%Y-%m-%d') }}</td>
              <td class="nowrap"><span class="status status-{{ r.status|lower }}">{{ r.status }}</span></td>
              <td>{{ r.reason or '' }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p>No recent requests.</p>
      {% endif %}
    </div>
  </div>
</div>

<style>
.cards-grid {
  display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 1rem; margin-bottom:1rem;
}
.kpi .kpi-title { font-size:.9rem; color:#1a237e; opacity:.8; margin-bottom:.25rem; }
.kpi .kpi-value { font-size:1.8rem; font-weight:700; }
.kpi .kpi-sub { font-size:.85rem; opacity:.75; margin-top:.25rem; }
.neg { color:#b71c1c; }

.table-wrap { overflow-x:auto; }
.table { width:100%; border-collapse:collapse; }
.table th, .table td { padding:.6rem; border-bottom:1px solid rgba(0,0,0,0.06); vertical-align:top; }
.table th { text-align:left; font-weight:600; }

.status { padding:.15rem .5rem; border-radius:.5rem; font-size:.85rem; }
.status-pending { background:#fff3cd; color:#7a5d00; }
.status-approved { background:#e6f4ea; color:#1b5e20; }
.status-disapproved { background:#fdecea; color:#7f1d1d; }
.status-cancelled { background:#eceff1; color:#263238; }
</style>
{% endblock %}
