{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="card">
  <div class="row">
    <h2>Manage Users</h2>
    <form class="right" method="get" action="{{ url_for('manage_users') }}">
      <input class="input-sm" type="text" name="q" placeholder="Search username…" value="{{ q or '' }}">
      <button class="btn sm" type="submit">Search</button>
    </form>
  </div>
</div>

<div class="card">
  <h3 style="margin-bottom:.8rem;">Add User</h3>
  <form method="post" action="{{ url_for('admin_create_user') }}">
    <div class="form-grid-3">
      <div>
        <label>Username</label>
        <input name="username" required>
      </div>
      <div>
        <label>Password</label>
        <input name="password" type="text" required>
      </div>
      <div>
        <label>Email (optional)</label>
        <input name="email" type="email">
      </div>
      <div>
        <label>Role</label>
        <select name="role">
          <option value="faculty_staff">Faculty/Staff</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div>
        <label>Hours Balance</label>
        <input name="hours_balance" type="number" step="0.01" placeholder="160.00">
      </div>
      <div class="row" style="align-items:end;">
        <button class="btn" type="submit">Create</button>
      </div>
    </div>
  </form>
</div>

<div class="card">
  <div class="row">
    <h3 style="margin-bottom:.8rem;">Bulk CSV Import</h3>
    <form method="post" action="{{ url_for('admin_import_users') }}" enctype="multipart/form-data" class="row">
      <input type="file" name="file" accept=".csv" required>
      <button class="btn" type="submit">Import</button>
      <span class="muted">Columns: username (required), email, role, hours_balance, password</span>
    </form>
  </div>
</div>

<div class="card">
  <h3 style="margin-bottom:.8rem;">All Users</h3>
  <table class="table-tight">
    <thead>
      <tr>
        <th>Username</th>
        <th>Email</th>
        <th>Role</th>
        <th>Hours</th>
        <th style="width:420px">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td><span class="badge blue">{{ 'Admin' if u.role=='admin' else 'Staff' }}</span> {{ u.username }}</td>
        <td>{{ u.email or '—' }}</td>
        <td>{{ 'Admin' if u.role=='admin' else 'Faculty/Staff' }}</td>
        <td>{{ '%.2f'|format(u.hours_balance or 0) }}</td>
        <td>
          <div class="row">
            <!-- Update inline -->
            <form method="post" action="{{ url_for('admin_update_user', user_id=u.id) }}" class="row">
              <input class="input-sm" name="username" placeholder="new username">
              <input class="input-sm" name="email" placeholder="email">
              <select class="input-sm" name="role">
                <option value="">(keep)</option>
                <option value="faculty_staff">Faculty/Staff</option>
                <option value="admin">Admin</option>
              </select>
              <input class="input-sm" name="hours_balance" type="number" step="0.01" placeholder="hours">
              <button class="btn sm" type="submit">Update</button>
            </form>

            <!-- Reset password -->
            <form method="post" action="{{ url_for('admin_reset_password', user_id=u.id) }}" class="row">
              <input class="input-sm" name="new_password" placeholder="new password" required>
              <button class="btn sm secondary" type="submit">Reset PW</button>
            </form>

            <!-- Delete -->
            <form method="post" action="{{ url_for('admin_delete_user', user_id=u.id) }}"
                  onsubmit="return confirm('Delete {{ u.username }}? This also deletes their requests.');">
              <button class="btn sm danger" type="submit">Delete</button>
            </form>
          </div>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="5" class="muted">No users found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
