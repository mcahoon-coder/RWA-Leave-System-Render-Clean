{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="card">
  <h1 style="margin-top:0;">Manage Users</h1>

  <form method="get" action="{{ url_for('manage_users') }}" style="margin-bottom:1rem; display:flex; gap:8px;">
    <input type="text" name="q" value="{{ q or '' }}" placeholder="Search usersâ€¦" style="flex:1;">
    <button class="btn sm" type="submit">Search</button>
    <a class="btn secondary sm" href="{{ url_for('manage_users') }}">Clear</a>
  </form>

  <table class="table-tight" style="font-size:.95rem;">
    <thead>
      <tr>
        <th>Username</th>
        <th>Email</th>
        <th>Role</th>
        <th>Balance</th>
        <th style="width:1%;">Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for u in users %}
      {% set is_neg = (u.hours_balance or 0) < 0 %}
      <tr>
        <td>{{ u.username }}</td>
        <td>{{ u.email or '' }}</td>
        <td>{{ u.role }}</td>
        <td style="color:{{ '#dc2626' if is_neg else '#065f46' }}; font-weight:600;">
          {{ '%.2f'|format(u.hours_balance or 0) }}h
        </td>
        <td style="white-space:nowrap;">
          <!-- Inline edit form -->
          <form method="post" action="{{ url_for('admin_update_user', user_id=u.id) }}" style="display:inline;">
            <button class="btn sm" type="submit">Edit</button>
          </form>
          <form method="post" action="{{ url_for('admin_reset_password', user_id=u.id) }}" style="display:inline;">
            <button class="btn sm" type="submit">Reset PW</button>
          </form>
          <form method="post" action="{{ url_for('admin_delete_user', user_id=u.id) }}" style="display:inline;">
            <button class="btn danger sm" type="submit">Delete</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="5" class="muted">No users found.</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <hr style="margin:1.2rem 0;">

  <h3>Add User</h3>
  <form method="post" action="{{ url_for('admin_create_user') }}" class="form-grid-3">
    <div>
      <label>Username</label>
      <input type="text" name="username" required>
    </div>
    <div>
      <label>Email</label>
      <input type="email" name="email">
    </div>
    <div>
      <label>Password</label>
      <input type="password" name="password" required>
    </div>
    <div>
      <label>Role</label>
      <select name="role">
        <option value="faculty_staff">Staff</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div>
      <label>Hours Balance</label>
      <input type="number" step="0.25" name="hours_balance" value="160.0">
    </div>
    <div style="align-self:end;">
      <button class="btn sm" type="submit">Add</button>
    </div>
  </form>
</div>
{% endblock %}
