{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}

{% block content %}
<h2>Manage Users</h2>

<form method="get" class="toolbar">
  <input type="text" name="q" value="{{ q or '' }}" placeholder="Search username..." />
  <button type="submit" class="btn">Search</button>
  <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">Clear</a>
</form>

<hr>

<h3>Create User</h3>
<form method="post" action="{{ url_for('admin_create_user') }}" class="card">
  <div class="grid grid-2">
    <div>
      <label>Username</label>
      <input name="username" required>
    </div>
    <div>
      <label>Email</label>
      <input name="email" type="email" placeholder="name@domain.com">
    </div>
    <div>
      <label>Role</label>
      <select name="role">
        <option value="faculty_staff">Faculty/Staff</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div>
      <label>Hours Balance</label>
      <input name="hours_balance" type="number" step="0.25" value="160">
    </div>
    <div>
      <label>Temporary Password</label>
      <input name="password" type="text" placeholder="Set an initial password" required>
    </div>
  </div>
  <div class="actions">
    <button class="btn">Create</button>
  </div>
</form>

<hr>

<h3>All Users</h3>

{% if users %}
  {% for u in users %}
  <form method="post" action="{{ url_for('admin_update_user', user_id=u.id) }}" class="card user-row">
    <div class="grid grid-5">
      <div>
        <label>Username</label>
        <input name="username" value="{{ u.username }}" required>
      </div>
      <div>
        <label>Email</label>
        <input name="email" type="email" value="{{ u.email or '' }}">
      </div>
      <div>
        <label>Role</label>
        <select name="role">
          <option value="faculty_staff" {{ 'selected' if u.role=='faculty_staff' else '' }}>Faculty/Staff</option>
          <option value="admin" {{ 'selected' if u.role=='admin' else '' }}>Admin</option>
        </select>
      </div>
      <div>
        <label>Hours Balance</label>
        <input name="hours_balance" type="number" step="0.25" value="{{ '%.2f'|format(u.hours_balance or 0) }}">
      </div>
      <div>
        <label>New Password</label>
        <input name="new_password" type="text" placeholder="(leave blank to keep)">
      </div>
    </div>
    <div class="actions spaced">
      <button class="btn">Save</button>
      <button class="btn btn-danger" formaction="{{ url_for('admin_delete_user', user_id=u.id) }}"
              formmethod="post" onclick="return confirm('Delete {{ u.username }}? This cannot be undone.');">
        Delete
      </button>
    </div>
  </form>
  {% endfor %}
{% else %}
  <p>No users found.</p>
{% endif %}

<hr>

<form method="post" action="{{ url_for('admin_test_email') }}">
  <button class="btn btn-secondary">Send Test Email to Admins</button>
</form>

{% endblock %}
