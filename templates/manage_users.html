{% extends "base.html" %}
{% block content %}
<h1>Manage Users</h1>

<div class="card">
  <h2>Create User</h2>
  <form method="post" action="{{ url_for('admin_create_user') }}" class="grid-2">
    <div>
      <label>Username</label>
      <input type="text" name="username" required>
    </div>
    <div>
      <label>Password</label>
      <input type="text" name="password" required>
    </div>
    <div>
      <label>Role</label>
      <select name="role">
        <option value="faculty">Faculty/Staff</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div>
      <label>Email (optional)</label>
      <input type="email" name="email" placeholder="name@example.com">
    </div>
    <div>
      <label>Starting Hours Balance</label>
      <input type="number" name="hours_balance" step="0.1" min="0" value="160">
    </div>
    <div class="row">
      <button type="submit" class="btn primary">Create</button>
    </div>
  </form>
</div>

<div class="card">
  <h2>All Users</h2>
  <form method="get" action="{{ url_for('manage_users') }}" class="row" style="gap:.5rem;">
    <input type="text" name="q" value="{{ q or '' }}" placeholder="Search by username">
    <button class="btn">Search</button>
    {% if q %}<a class="btn" href="{{ url_for('manage_users') }}">Clear</a>{% endif %}
  </form>

  <div class="table">
    <div class="table-row table-header">
      <div>Username</div>
      <div>Role</div>
      <div>Email</div>
      <div>Hours Balance</div>
      <div>Actions</div>
    </div>

    {% for u in users %}
    <div class="table-row">
      <form method="post" action="{{ url_for('admin_update_user', user_id=u.id) }}" class="row stretch">
        <div>
          <input type="text" name="username" value="{{ u.username }}" required>
        </div>
        <div>
          <select name="role">
            <option value="faculty" {% if u.role != 'admin' %}selected{% endif %}>Faculty/Staff</option>
            <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>Admin</option>
          </select>
        </div>
        <div>
          <input type="email" name="email" value="{{ u.email or '' }}" placeholder="name@example.com">
        </div>
        <div>
          <input type="number" name="hours_balance" step="0.1" min="0" value="{{ '%.1f'|format(u.hours_balance or 0) }}">
        </div>
        <div class="row" style="gap:.4rem;">
          <button class="btn small primary" type="submit">Save</button>
        </div>
      </form>

      <form method="post" action="{{ url_for('admin_reset_password', user_id=u.id) }}" class="row" style="gap:.4rem; margin-top:.25rem;">
        <input type="text" name="new_password" placeholder="New password">
        <button class="btn small" type="submit">Reset PW</button>
      </form>

      <form method="post" action="{{ url_for('admin_delete_user', user_id=u.id) }}"
            onsubmit="return confirm('Delete {{ u.username }}? This cannot be undone.');"
            class="row" style="gap:.4rem; margin-top:.25rem;">
        <button class="btn small danger" type="submit">Delete</button>
      </form>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
