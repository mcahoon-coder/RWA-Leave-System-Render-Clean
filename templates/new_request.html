{# templates/new_request.html #}
{% extends "base.html" %}
{% block title %}New Request{% endblock %}

{% block content %}
<h2>New Request</h2>

<div class="card" style="padding:1rem;">
  <form method="post" action="{{ url_for('new_request') }}" id="leave-form"
        style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:0.75rem;align-items:end;">

    <!-- Kind -->
    <div>
      <label for="kind">Kind</label>
      <select class="input" name="kind" id="kind" required>
        <option value="annual">Annual</option>
        <option value="sick">Sick</option>
      </select>
    </div>

    <!-- Mode -->
    <div>
      <label for="mode">Mode</label>
      <select class="input" name="mode" id="mode" required>
        <option value="hourly" selected>Hourly (uses Start/End times)</option>
        <option value="daily">Daily (full workdays)</option>
        <option value="halfday">Half Day (4.00h)</option>
      </select>
    </div>

    <!-- Dates -->
    <div>
      <label for="start_date">Start Date</label>
      <input class="input" type="date" name="start_date" id="start_date" required>
    </div>
    <div>
      <label for="end_date">End Date</label>
      <input class="input" type="date" name="end_date" id="end_date" required>
    </div>

    <!-- Time range (only for Hourly) -->
    <div class="hourly-only">
      <label for="start_time">Start Time</label>
      <select class="input" name="start_time" id="start_time">
        {% for hh in range(0,24) %}
          {% for mm in [0,15,30,45] %}
            {% set HH = "%02d"|format(hh) %}
            {% set MM = "%02d"|format(mm) %}
            <option value="{{ HH }}:{{ MM }}">{{ (HH ~ ":" ~ MM)|h12 }}</option>
          {% endfor %}
        {% endfor %}
      </select>
    </div>
    <div class="hourly-only">
      <label for="end_time">End Time</label>
      <select class="input" name="end_time" id="end_time">
        {% for hh in range(0,24) %}
          {% for mm in [0,15,30,45] %}
            {% set HH = "%02d"|format(hh) %}
            {% set MM = "%02d"|format(mm) %}
            <option value="{{ HH }}:{{ MM }}">{{ (HH ~ ":" ~ MM)|h12 }}</option>
          {% endfor %}
        {% endfor %}
      </select>
    </div>

    <!-- School related -->
    <div>
      <label for="school_related">School Related?</label><br>
      <input type="checkbox" name="school_related" id="school_related" value="1">
    </div>

    <!-- Reason -->
    <div style="grid-column:1/-1">
      <label for="reason">Reason (optional)</label>
      <textarea class="input" name="reason" id="reason" rows="3" placeholder="Optional"></textarea>
    </div>

    <!-- Submit -->
    <div style="grid-column:1/-1;display:flex;gap:.5rem;justify-content:flex-end;">
      <button type="submit" class="btn">Submit Request</button>
      <a class="btn" href="{{ url_for('my_requests') }}">Cancel</a>
    </div>
  </form>

  <p style="margin-top:.75rem;opacity:.7;">
    <strong>Note:</strong> For <em>Hourly</em> requests, hours will be calculated automatically from the selected Start and End times and shown on the “My Requests” page.
  </p>
</div>

<script>
  (function () {
    const modeSel = document.getElementById('mode');
    const hourlyBlocks = document.querySelectorAll('.hourly-only');
    const startTime = document.getElementById('start_time');
    const endTime   = document.getElementById('end_time');
    const startDate = document.getElementById('start_date');
    const endDate   = document.getElementById('end_date');

    function toggleHourly() {
      const hourly = modeSel.value === 'hourly';
      hourlyBlocks.forEach(el => el.style.display = hourly ? '' : 'none');

      // When switching away from hourly, clear times; when switching to hourly, ensure same-day by default
      if (!hourly) {
        if (startTime) startTime.value = '';
        if (endTime) endTime.value = '';
      } else {
        // default end date to start date if empty/different
        if (startDate && endDate && startDate.value && endDate.value !== startDate.value) {
          endDate.value = startDate.value;
        }
      }
    }

    modeSel.addEventListener('change', toggleHourly);
    toggleHourly();
  })();
</script>
{% endblock %}
