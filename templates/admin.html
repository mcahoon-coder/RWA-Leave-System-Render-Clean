{% extends "base.html" %}
{% block title %}Admin{% endblock %}

{% block content %}
  <!-- Admin Hub header + quick links -->
  <div class="card">
    <h1 style="margin-top:0;">Admin</h1>
    <p>Quick links:</p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="{{ url_for('manage_users') }}">Manage Users</a>
      <a class="btn" href="{{ url_for('my_requests') }}?status=Pending">View Pending Requests</a>
      <a class="btn" href="{{ url_for('calendar') }}">Calendar</a>
      <a class="btn" href="{{ url_for('export_requests_csv') }}">Export CSV</a>
      <a class="btn" href="{{ url_for('export_requests_xlsx') }}">Export Excel</a>
    </div>
  </div>

  <!-- Approvals panel with ACTION BUTTONS (no dropdowns) -->
  <div class="card">
    <h2 style="margin-top:0;">Approvals</h2>

    {% if pending and pending|length %}
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Kind</th>
            <th>Mode</th>
            <th>Hours</th>
            <th>School</th>
            <th style="min-width:260px;">Substitutes</th>
            <th>Dates</th>
            <th>Reason</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in pending %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.user.username }}</td>
              <td>{{ r.kind }}</td>
              <td>{{ r.mode }}</td>
              <td>{{ '%.2f'|format(r.hours) }}</td>
              <td>{{ 'Yes' if r.is_school_related else 'No' }}</td>

              <!-- Substitute editor (inline) -->
              <td>
                {% if r.subs and r.subs|length %}
                  <ul style="margin:0; padding-left:18px;">
                    {% for s in r.subs %}
                      <li>
                        <form method="post"
                              action="{{ url_for('update_substitute', req_id=r.id, sub_id=s.id) }}"
                              style="display:inline-flex; gap:6px; align-items:center;">
                          <input name="sub_name" value="{{ s.name }}" style="max-width:130px;">
                          <input name="sub_hours" type="number" step="0.25" value="{{ '%.2f'|format(s.hours) }}" style="width:90px;">
                          <button class="btn" type="submit">Save</button>
                        </form>
                        <form method="post"
                              action="{{ url_for('delete_substitute', req_id=r.id, sub_id=s.id) }}"
                              style="display:inline;">
                          <button class="btn" type="submit">✕</button>
                        </form>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <em>No subs yet</em>
                {% endif %}

                <!-- Add new sub -->
                <form method="post"
                      action="{{ url_for('add_substitute', req_id=r.id) }}"
                      style="display:flex; gap:6px; align-items:center; margin-top:6px;">
                  <input name="sub_name" placeholder="Name" required style="max-width:130px;">
                  <input name="sub_hours" type="number" step="0.25" placeholder="Hours" style="width:90px;">
                  <button class="btn" type="submit">Add</button>
                </form>
              </td>

              <td>{{ r.start_date }} → {{ r.end_date }}</td>
              <td>{{ r.reason }}</td>

              <!-- ACTION BUTTONS (no selects) -->
              <td>
                <!-- Toggle school tag -->
                {% if not r.is_school_related %}
                  <form method="post" action="{{ url_for('mark_school_related', req_id=r.id) }}" style="display:inline;">
                    <button class="btn" type="submit">Mark School</button>
                  </form>
                {% else %}
                  <form method="post" action="{{ url_for('unmark_school_related', req_id=r.id) }}" style="display:inline;">
                    <button class="btn" type="submit">Unmark School</button>
                  </form>
                {% endif %}

                <!-- Approve / Disapprove -->
                <form method="post" action="{{ url_for('approve', req_id=r.id) }}" style="display:inline;">
                  <button class="btn" type="submit">Approve</button>
                </form>
                <form method="post" action="{{ url_for('disapprove', req_id=r.id) }}" style="display:inline;">
                  <button class="btn" type="submit">Disapprove</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No pending requests.</p>
    {% endif %}
  </div>

  <!-- Reports panel (unchanged) -->
  <div class="card">
    <h2 style="margin-top:0;">Reports</h2>
    <p>Download current filtered data from the Requests page, or export everything here:</p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="{{ url_for('export_requests_csv') }}">Export CSV</a>
      <a class="btn" href="{{ url_for('export_requests_xlsx') }}">Export Excel</a>
    </div>
  </div>
{% endblock %}
